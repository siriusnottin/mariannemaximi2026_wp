name: Build Bedrock (reusable)

on:
  workflow_call:
    outputs:
      artifact-name:
        description: Name of the uploaded artifact
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: bedrock-artifact
    env:
      PHP_VERSION: "8.2"
      COMPOSER_FLAGS: "--no-dev --prefer-dist --optimize-autoloader"
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer

      - uses: actions/cache@v4
        with:
          path: ~/.cache/composer
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install $COMPOSER_FLAGS

      - name: Ensure composer cache dir exists
        run: |
          mkdir -p ~/.cache/composer

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          # Use git archive to respect .gitignore and only include tracked files
          git archive --format=tar HEAD | tar -x -C artifact/
          
          # Remove files we don't want in production (using .export-ignore logic manually if needed, 
          # but git archive respects .gitattributes export-ignore if we set it up. 
          # For now, we'll just remove the specific ones you mentioned if they are tracked)
          rm -rf artifact/docker-compose.yml artifact/.docker artifact/wp-cli.yml artifact/pint.json artifact/scripts

          # Add vendor directory (ignored by git but needed for prod)
          cp -r vendor artifact/
          
          # Add web/wp directory (ignored by git but needed for prod)
          cp -r web/wp artifact/web/

          # Ensure dotfiles that might be omitted by some runners or tools
          # are present in the artifact (explicit fallback for .htaccess)
          mkdir -p artifact/web
          if [ -f web/.htaccess ]; then
            cp -f web/.htaccess artifact/web/.htaccess
          else
            echo "web/.htaccess not found, failing build"
            exit 1
          fi

      - name: Verify Bedrock files
        run: |
          test -f artifact/web/.htaccess || (echo "Missing artifact/web/.htaccess" && exit 1)
          test -f artifact/web/wp/wp-admin/install.php || (echo "Missing WordPress core in artifact/web/wp" && exit 1)

      - name: Archive artifact
        run: |
          tar -czf bedrock-artifact.tar.gz -C artifact .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bedrock-artifact
          path: bedrock-artifact.tar.gz
