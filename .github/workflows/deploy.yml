name: Deploy Bedrock to OVH (SFTP)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    uses: ./.github/workflows/build.yml

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bedrock-artifact

      - name: Extract artifact
        run: |
          mkdir -p artifact
          tar -xzf bedrock-artifact.tar.gz -C artifact
          rm bedrock-artifact.tar.gz

      - name: Sanity check artifact
        run: |
          ls -la artifact/web/
          test -d artifact || (echo "artifact/ missing" && exit 1)
          test -f artifact/web/.htaccess || (echo "Missing artifact/web/.htaccess" && exit 1)
          test -f artifact/web/wp/wp-admin/install.php || (echo "Missing WordPress core in artifact/web/wp" && exit 1)

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy via SFTP (lftp)
        env:
          SFTP_HOST: ${{ secrets.OVH_SFTP_HOST }}
          SFTP_USER: ${{ secrets.OVH_SFTP_USER }}
          SFTP_PASS: ${{ secrets.OVH_SFTP_PASSWORD }}
          SFTP_PORT: ${{ secrets.OVH_SFTP_PORT }}
          REMOTE_DIR: ${{ secrets.OVH_REMOTE_WP_CURRENT }}
        run: |
          lftp -e "set sftp:auto-confirm yes; open sftp://$SFTP_USER:$SFTP_PASS@$SFTP_HOST:$SFTP_PORT; mirror -R --verbose --parallel=10 --exclude .env --exclude app/uploads/ artifact/web/ $REMOTE_DIR; bye"
